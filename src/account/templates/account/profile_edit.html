{% extends "core/base.html" %}
{% load static %}

{% block title %}プロフィール編集 - {{ SITE_NAME }}{% endblock %}

{# --- Alpine.js Data --- #}
{% block extra_js_scripts %}
<script>
    function profileEditData() {
        return {
            previewUrl: '{% if user.user_profile.icon %}{{ user.user_profile.icon.url }}{% endif %}', 
            isDragging: false,
            uploadedFile: null,
            iconClear: false,

            handleFileChange(event) {
                const file = event.target.files[0];
                if (file) {
                    this.previewUrl = URL.createObjectURL(file);
                    this.uploadedFile = file;
                    this.iconClear = false;
                }
            },

            handleDrop(event) {
                this.isDragging = false;
                const file = event.dataTransfer.files[0];
                if (file) {
                    if (file.type.startsWith('image/')) {
                        this.$refs.fileInput.files = event.dataTransfer.files;
                        this.previewUrl = URL.createObjectURL(file);
                        this.uploadedFile = file;
                        this.iconClear = false;
                    }
                }
            },
            
            triggerFileInput() {
                this.$refs.fileInput.click();
            },
            
            clearIcon() {
                this.previewUrl = '';
                this.uploadedFile = null;
                this.$refs.fileInput.value = '';
                this.iconClear = true;
            }
        }
    }
</script>
{% endblock %}

{% block content %}

<div class="container mx-auto max-w-4xl" x-data="profileEditData()">
  <div class="mb-6">
    <h1 class="text-2xl font-bold">プロフィール編集</h1>
    <a href="{% url 'account:profile' 'me' %}" class="link link-primary mt-2 inline-block text-sm">← プロフィールに戻る</a>
  </div>

  <div class="card bg-base-100 shadow-xl rounded-lg">
    <div class="card-body">
      {# Django標準のフォーム送信を利用 #}
      <form method="post" action="" enctype="multipart/form-data">
        {% csrf_token %}
        
        {# フォームの全体エラー表示 #}
        {% if form.non_field_errors %}
          <div role="alert" class="alert alert-error mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
              {% for error in form.non_field_errors %}
                <span class="font-medium block">{{ error }}</span>
              {% endfor %}
            </div>
          </div>
        {% endif %}

        {# 基本情報セクション #}
        <h2 class="text-xl font-semibold mb-3">基本情報</h2>
        
        {# 表示名 #}
        {% with field=form.display_name %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }} <span class="text-error">*</span></span>
            </label>
            <input type="text" 
                 name="{{ field.name }}"
                 id="{{ field.id_for_label }}"
                 placeholder="例: Kenji_Dev" 
                 class="input input-bordered w-full {% if field.errors %}input-error{% endif %}" 
                 required
                 value="{{ field.value|default_if_none:'' }}"/>
            
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
            
            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        {# アイコン #}
        {% with field=form.icon %}
          <div class="form-control mb-6">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }}</span>
            </label>
            
            <div class="relative border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-all duration-200 group"
                 :class="{ 'border-primary bg-primary/5': isDragging, 'border-base-300 hover:border-primary hover:bg-base-200': !isDragging }"
                 @dragover.prevent="isDragging = true"
                 @dragleave.prevent="isDragging = false"
                 @drop.prevent="handleDrop($event)"
                 @click="triggerFileInput()">
                 
                 <input type="file" 
                      name="{{ field.name }}"
                      id="{{ field.id_for_label }}"
                      accept="image/*"
                      class="hidden"
                      x-ref="fileInput"
                      @change="handleFileChange($event)"/>

                 <div class="flex flex-col items-center gap-4 pointer-events-none">
                    <!-- Preview Area -->
                    <div class="avatar">
                        <div class="w-32 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2 bg-base-100 shadow-md">
                            <template x-if="previewUrl">
                                <img :src="previewUrl" class="object-cover" alt="Profile Icon" />
                            </template>
                            <template x-if="!previewUrl">
                                <div class="flex items-center justify-center w-full h-full bg-base-300 text-base-content/50">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <p class="font-medium text-base">
                            <span class="text-primary">クリックして画像を選択</span> またはドラッグ＆ドロップ
                        </p>
                        <p class="text-xs text-base-content/60">
                            推奨: 500x500px 以上の正方形 (JPG, PNG)
                        </p>
                    </div>
                 </div>
            </div>
            
            <!-- Remove Button -->
            <div class="mt-2 text-center" x-show="previewUrl">
                <button type="button" class="btn btn-sm btn-ghost text-error" @click="clearIcon()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    画像を削除
                </button>
            </div>
            
            <!-- Hidden inputs for form submission -->
            <input type="checkbox" name="icon_clear" class="hidden" x-model="iconClear" />
                 
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}

            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        <div class="divider"></div>

        {# 詳細情報セクション #}
        <h2 class="text-xl font-semibold mb-3">詳細情報</h2>

        {# 自己紹介 #}
        {% with field=form.bio %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }}</span>
            </label>
            <textarea name="{{ field.name }}"
                    id="{{ field.id_for_label }}"
                    class="textarea textarea-bordered w-full {% if field.errors %}textarea-error{% endif %}"
                    rows="4"
                    placeholder="自己紹介文を入力してください（最大500文字）">{{ field.value|default_if_none:'' }}</textarea>
            
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
            
            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        {# 経歴 #}
        {% with field=form.career_history %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }}</span>
            </label>
            <textarea name="{{ field.name }}"
                    id="{{ field.id_for_label }}"
                    class="textarea textarea-bordered w-full {% if field.errors %}textarea-error{% endif %}"
                    rows="6"
                    placeholder="職務経歴や学歴などを入力してください">{{ field.value|default_if_none:'' }}</textarea>
            
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
            
            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        {# 所在地 #}
        {% with field=form.location %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }}</span>
            </label>
            <input type="text" 
                 name="{{ field.name }}"
                 id="{{ field.id_for_label }}"
                 placeholder="例：東京都、日本" 
                 class="input input-bordered w-full {% if field.errors %}input-error{% endif %}" 
                 value="{{ field.value|default_if_none:'' }}"/>
            
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
            
            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        {# 技術タグ #}
        {% with field=form.skill_tags_raw %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }}</span>
            </label>
            <input type="text" 
                 name="{{ field.name }}"
                 id="{{ field.id_for_label }}"
                 placeholder="例：Python, Django, React" 
                 class="input input-bordered w-full {% if field.errors %}input-error{% endif %}" 
                 value="{{ field.value|default_if_none:'' }}"/>
            
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
            
            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        <div class="divider"></div>
        <h2 class="text-xl font-semibold mb-3">表示設定</h2>

        {# Theme #}
        <div class="form-control mb-4">
            <label class="label" for="{{ form.theme.id_for_label }}">
                <span class="label-text font-bold">テーマ</span>
            </label>
            <select name="{{ form.theme.name }}" 
                    id="{{ form.theme.id_for_label }}"
                    class="select select-bordered w-full max-w-xs"
                    @change="activeTheme = $event.target.value">
              {% for value, label in form.theme.field.choices %}
                <option value="{{ value }}" {% if form.theme.value == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            {% if form.theme.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ form.theme.help_text }}</span>
              </label>
            {% endif %}
        </div>

        <div class="divider"></div>

        {# リンク情報セクション #}
        <h2 class="text-xl font-semibold mb-3">リンク情報</h2>

        {# GitHubリンク #}
        {% with field=form.github_link %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }}</span>
            </label>
            <input type="url" 
                 name="{{ field.name }}"
                 id="{{ field.id_for_label }}"
                 placeholder="https://github.com/username" 
                 class="input input-bordered w-full {% if field.errors %}input-error{% endif %}" 
                 value="{{ field.value|default_if_none:'' }}"/>
            
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
            
            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        {# X (Twitter)リンク #}
        {% with field=form.x_link %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }}</span>
            </label>
            <input type="url" 
                 name="{{ field.name }}"
                 id="{{ field.id_for_label }}"
                 placeholder="https://x.com/username" 
                 class="input input-bordered w-full {% if field.errors %}input-error{% endif %}" 
                 value="{{ field.value|default_if_none:'' }}"/>
            
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
            
            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        {# ポートフォリオ/ブログリンク #}
        {% with field=form.portfolio_blog_link %}
          <div class="form-control mb-4">
            <label class="label">
              <span class="label-text font-bold">{{ field.label }}</span>
            </label>
            <input type="url" 
                 name="{{ field.name }}"
                 id="{{ field.id_for_label }}"
                 placeholder="https://example.com" 
                 class="input input-bordered w-full {% if field.errors %}input-error{% endif %}" 
                 value="{{ field.value|default_if_none:'' }}"/>
            
            {% if field.help_text %}
              <label class="label">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
            
            {% if field.errors %}
              <label class="label pt-0">
                <span class="label-text-alt text-error">
                  {% for error in field.errors %}{{ error }}{% endfor %}
                </span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        <div class="divider"></div>

        {# 設定セクション #}
        <h2 class="text-xl font-semibold mb-3">設定</h2>

        {# プロフィール公開 #}
        {% with field=form.is_public %}
          <div class="form-control mb-4">
            <label class="label cursor-pointer p-0">
              <span class="label-text">{{ field.label }}</span>
              <input type="checkbox" 
                  name="{{ field.name }}"
                  id="{{ field.id_for_label }}"
                  class="checkbox checkbox-sm checkbox-primary" 
                  {% if field.value %}checked{% endif %} />
            </label>
            {% if field.help_text %}
              <label class="label pt-0">
                <span class="label-text-alt text-base-content/70">{{ field.help_text }}</span>
              </label>
            {% endif %}
          </div>
        {% endwith %}

        {# 送信ボタン #}
        <div class="form-control mt-6">
          <div class="flex gap-4">
            <button type="submit" class="btn btn-primary flex-1">更新する</button>
            <a href="{% url 'account:profile' 'me' %}" class="btn btn-outline">キャンセル</a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

