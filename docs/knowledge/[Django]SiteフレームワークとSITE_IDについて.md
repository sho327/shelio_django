📘 Django / Site フレームワークと `SITE_ID` について

---

## 1. Site フレームワーク（`django.contrib.sites`）の概要

Site フレームワークは、**単一の Django プロジェクトで複数のドメインを管理する**ための組み込み機能です。

これは主に、コード内にドメイン名を**ハードコードするのを避け**、メール通知、絶対 URL の生成、RSS フィード、サイトマップなどの機能で**動的にドメイン情報を利用する**ために使われます。

### 主な役割

- メールなどの通知に**正しいドメイン**を含める。
- **マルチテナント**や**マルチブランド**のサービスを一つのコードベースで運用する際のドメイン管理。

---

## 2. `settings.SITE_ID` の意味と役割

`SITE_ID` は、Django の設定ファイル (`settings.py`) で定義される**整数値**です。

これは、Site フレームワークに対して、**データベースの `django_site` テーブル内のどのレコードを「現在のサイト」として参照すべきか**を指示する役割を持ちます。

### 🚨 注意点

- **自動設定ではない:** `SITE_ID = 1` と設定しても、Django が自動的に現在アクセスされているドメインを認識して設定するわけではありません。これは**データベースのレコード ID**を指定するものです。
- **初期値の修正が必須:** マイグレーション後、ID=1 のレコードはデフォルトで`example.com`となっているため、**管理画面から必ず正しいドメインに手動で修正**する必要があります。

---

## 3. Site フレームワークのデータと設定

### 💻 設定手順

| ステップ                | 内容                              | 目的                                                  |
| :---------------------- | :-------------------------------- | :---------------------------------------------------- |
| **1. `INSTALLED_APPS`** | `'django.contrib.sites'` を追加   | フレームワークを有効化する                            |
| **2. `settings.py`**    | `SITE_ID = 1` を定義              | デフォルトで参照する DB のレコード ID を指定          |
| **3. `migrate` 実行**   | `python manage.py migrate`        | `django_site` テーブルを作成し、ID=1 のレコードを挿入 |
| **4. 管理画面**         | ID=1 のレコードの**Domain**を修正 | 例: `example.com` → `shelio.com`                      |

### 📜 Site モデルのデータ構造

`django_site` テーブルは、ドメイン情報と管理用の表示名を保持します。

| フィールド    | 説明                                                    | 例                                       |
| :------------ | :------------------------------------------------------ | :--------------------------------------- |
| **`id` (PK)** | Site レコードのプライマリキー（`SITE_ID` が参照する値） | 1, 2, 3...                               |
| **`domain`**  | サイトのドメイン名                                      | `shelio.com` または `staging.shelio.com` |
| **`name`**    | 管理画面での表示名                                      | `メインプロダクション`                   |

---

## 4. マルチサイトと動的な切り替え

Site フレームワークは、複数のドメインをデータベースで管理し、コードから柔軟に参照できるように設計されています。

### 🌐 データベースによるマルチサイト管理

データベースに複数の Site レコードを作成することで、マルチサイト運用が可能です。

| ID  | Domain            | Name                       |
| :-- | :---------------- | :------------------------- |
| 1   | `shelio.com`      | 本番サイト                 |
| 2   | `docs.shelio.com` | ドキュメント用サブドメイン |

### 🛠️ コードでの参照方法

標準の `SITE_ID` ではなく、特定の属性（ユーザーの権限やメールアドレスなど）に基づいて参照する Site を動的に切り替えるには、カスタムロジックが必要です。

| ユースケース     | 実装方法                                                                                                                                                                             | コード例                                                                    |
| :--------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------- |
| **固定参照**     | `Site.objects.get_current()` または `Site.objects.get(pk=ID)`                                                                                                                        | `current_site = Site.objects.get_current()`                                 |
| **ユーザー属性** | ユーザーの属性（`is_staff` やメールアドレスのドメインなど）に基づいて、ロジック内で参照すべき `Site ID` を決定する。                                                                 | `if user.is_staff: site_id = settings.STAGING_SITE_ID`                      |
| **アクセス元**   | `django.contrib.sites.middleware.CurrentSiteMiddleware` を使用する。アクセスされたドメイン名（`request.get_host()`）と一致する DB レコードを自動的に「現在のサイト」として設定する。 | `Site.objects.get_current()` がアクセス元ドメインの Site を返すようになる。 |
